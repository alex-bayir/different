<!DOCTYPE html>
<html lang="ru">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Report ({{events-date-export}})</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/papaparse@5.3.0/papaparse.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 4px;
            background-color: #f5f5f5;
        }

        .container {
            max-width: 210mm;
            margin: 0 auto;
            padding: 4px;
            text-align: center;

            background-color: white;
            border-radius: 8px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);

        }

        h1 {
            color: #333;
            font-size: 24px;
        }

        h2 {
            color: #333;
            font-size: 20px;
        }

        .charts-container {
            display: flex;
            flex-wrap: wrap;
            gap: 4px;
        }

        .chart-box {
            flex: 1 1 300px;
            min-width: 300px;
            max-width: 400px;
            max-height: 200px;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 8px;
            background-color: white;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
            font-size: 16px;
        }

        th,
        td {
            border: 1px solid #ddd;
            padding: 2px;
            text-align: left;
        }

        th {
            background-color: #f2f2f2;
        }

        .loading {
            margin: 20px 0;
            color: #666;
            font-style: italic;
        }

        .hide {
            display: none;
        }

        .no-print {
            display: block;
        }

        /* Стили для печати */
        @media print {
            @page {
                margin: 0;
                size: auto;
            }

            .no-print {
                display: none !important;
            }

            .print-only {
                display: block !important;
            }

            body {
                margin: 0;
                font-size: 12pt;
                line-height: 1.4;
            }

            /* Убираем фоны для экономии чернил */
            * {
                background: transparent !important;
                color: black !important;
                box-shadow: none !important;
                text-shadow: none !important;
            }

            /* Указываем области печати */
            .print-area {
                page-break-inside: avoid;
            }
        }
    </style>
</head>

<body>
    <div class="container">
        <img src="https://lp.kaspersky.com/ru/wp-content/themes/kuma/images/hero-bg.jpg" alt="logo" style="margin-top: 20px;"></img>
        <h1 style="text-align:center">Information Security Events Report</br>{{events-date-export}}</h1>
        <div class="loading" id="loading">loading...</div>
        <div id="report-content" style="display: none;">
            <div class="print-area">
                <h2 style="text-align:center">Distribution of events by source</h2>
                <div class="charts-container">
                    <div class="chart-box">
                        <canvas id="eventsChart"></canvas>
                    </div>
                    <div class="chart-box">
                        <canvas id="alertsChart"></canvas>
                    </div>
                </div>
                <table id="events-table">
                    <thead>
                        <tr>
                            <th style="text-align:center">source</th>
                            <th style="text-align:center">events</th>
                            <th style="text-align:center">alerts</th>
                        </tr>
                    </thead>
                    <tbody id="events-table-body">
                    </tbody>
                </table>
            </div>
            <div class="print-area">
                <h2 style="text-align:center">Alerts</h2>
                <div class="charts-container">
                    <div class="chart-box">
                        <canvas id="alertsPriorityChart"></canvas>
                    </div>
                    <div class="chart-box">
                        <canvas id="alertsTypesChart"></canvas>
                    </div>
                </div>
                <table id="alerts-table">
                    <thead>
                        <tr>
                            <th style="text-align:center">alert</th>
                            <th style="text-align:center">count</th>
                        </tr>
                    </thead>
                    <tbody id="alerts-table-body">
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        String.prototype.ellip = function (length) {
            return this.length > length ? this.substring(0, length) + "…" : this;
        }
        const eventsCSV = `source,base,correlated\n{{events-data-export}}`;
        const alertsCSV = `priority,rule,count\n{{alerts-data-export}}`;

        let events = [];
        let alerts = [];
        let charts = {
            eventsChart: null,
            alertsChart: null,
            alertsPriorityChart: null,
            alertsTypesChart: null
        };

        function formatNumber(num) {
            return num.toString().replace(/\B(?=(\d{3})+(?!\d))/g, " ");
        }

        function initializeReport() {
            events = Papa.parse(eventsCSV, { header: true }).data.map(row => ({
                source: row['source'],
                events: parseInt(row['base']) || 0,
                alerts: parseInt(row['correlated']) || 0
            })).filter(item => item.source);

            alerts = Papa.parse(alertsCSV, { header: true }).data.map(row => ({
                count: parseInt(row['count']) || 0,
                priority: row['priority'],
                rule: row['rule']
            })).filter(item => item.rule);

            events.sort((a, b) => b.events - a.events);
            alerts.sort((a, b) => b.count - a.count);

            createEventsChart();
            createAlertsChart();
            createAlertsPriorityChart();
            createAlertsTypesChart();

            fillEventsTable();
            fillAlertsTable();

            document.getElementById('loading').style.display = 'none';
            document.getElementById('report-content').style.display = 'block';
        }

        function createEventsChart() {
            const ctx = document.getElementById('eventsChart').getContext('2d');

            const topEvents = events.slice(0, 5);
            const othersEvents = events.slice(5).reduce((sum, item) => sum + item.events, 0);

            const labels = [
                ...topEvents.map(item => `${item.source.ellip(16)}: ${formatNumber(item.events)}`),
                `Others: ${formatNumber(othersEvents)}`
            ];

            const data = [
                ...topEvents.map(item => item.events),
                othersEvents
            ];

            if (charts.eventsChart) {
                charts.eventsChart.destroy();
            }

            charts.eventsChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: labels,
                    datasets: [{
                        data: data,
                        borderWidth: 0,
                        backgroundColor: [
                            '#FF6384',
                            '#36A2EB',
                            '#FFCE56',
                            '#4BC0C0',
                            '#9966FF',
                            '#C9CBCF'
                        ]
                    }]
                },
                options: getChartOptions('Events by source')
            });
        }

        function createAlertsChart() {
            const ctx = document.getElementById('alertsChart').getContext('2d');

            const withAlerts = events.filter(item => item.alerts > 0);

            const topAlerts = withAlerts.slice(0, 5);
            const othersAlerts = withAlerts.slice(5).reduce((sum, item) => sum + item.alerts, 0);

            const labels = [
                ...topAlerts.map(item => `${item.source.ellip(16)}: ${formatNumber(item.alerts)}`),
                othersAlerts > 0 ? `Others: ${formatNumber(othersAlerts)}` : null
            ].filter(Boolean);

            const data = [
                ...topAlerts.map(item => item.alerts),
                othersAlerts
            ].filter(item => item > 0);

            if (charts.alertsChart) {
                charts.alertsChart.destroy();
            }

            charts.alertsChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: labels,
                    datasets: [{
                        data: data,
                        borderWidth: 0,
                        backgroundColor: [
                            '#FF6384',
                            '#36A2EB',
                            '#FFCE56',
                            '#4BC0C0',
                            '#9966FF',
                            '#C9CBCF'
                        ].slice(0, labels.length)
                    }]
                },
                options: getChartOptions('Alerts by source')
            });
        }

        function createAlertsPriorityChart() {
            const ctx = document.getElementById('alertsPriorityChart').getContext('2d');

            const priorityGroups = {
                'Critical': 0,
                'High': 0,
                'Medium': 0,
                'Low': 0
            };

            alerts.forEach(alert => {
                if (alert.priority.includes('☢️')) priorityGroups['Critical'] += alert.count;
                else if (alert.priority.includes('🔴')) priorityGroups['High'] += alert.count;
                else if (alert.priority.includes('🟡')) priorityGroups['Medium'] += alert.count;
                else if (alert.priority.includes('🟢')) priorityGroups['Low'] += alert.count;
            });

            const labels = Object.keys(priorityGroups).map(key =>
                `${key.ellip(16)}: ${formatNumber(priorityGroups[key])}`
            );
            const data = Object.values(priorityGroups);

            if (charts.alertsPriorityChart) {
                charts.alertsPriorityChart.destroy();
            }

            charts.alertsPriorityChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: labels,
                    datasets: [{
                        data: data,
                        borderWidth: 0,
                        backgroundColor: [
                            '#940000',
                            '#FF0000',
                            '#FFFF00',
                            '#00FF00'
                        ]
                    }]
                },
                options: getChartOptions('Alerts by priority')
            });
        }

        function createAlertsTypesChart() {
            const ctx = document.getElementById('alertsTypesChart').getContext('2d');

            const topAlerts = alerts.slice(0, 5);
            const othersAlerts = alerts.slice(5).reduce((sum, item) => sum + item.count, 0);

            const labels = [
                ...topAlerts.map(item => `${item.rule.ellip(16)}: ${formatNumber(item.count)}`),
                `Others: ${formatNumber(othersAlerts)}`
            ];

            const data = [
                ...topAlerts.map(item => item.count),
                othersAlerts
            ];

            if (charts.alertsTypesChart) {
                charts.alertsTypesChart.destroy();
            }

            charts.alertsTypesChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: labels,
                    datasets: [{
                        data: data,
                        borderWidth: 0,
                        backgroundColor: [
                            '#FF6384',
                            '#36A2EB',
                            '#FFCE56',
                            '#4BC0C0',
                            '#9966FF',
                            '#C9CBCF'
                        ]
                    }]
                },
                options: getChartOptions('Alerts by type')
            });
        }

        function getChartOptions(title) {
            return {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'right',
                        labels: {
                            boxWidth: 12,
                            font: {
                                size: 12,
                                family: 'Consolas'
                            }
                        }
                    },
                    tooltip: {
                        callbacks: {
                            label: (context) => (context.label || '')
                        }
                    },
                    title: {
                        display: true,
                        padding: 0,
                        text: title,
                        font: {
                            size: 16
                        }
                    }
                }
            };
        }

        function fillEventsTable() {
            const tbody = document.getElementById('events-table-body');
            tbody.innerHTML = '';

            events.forEach(item => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td style="text-align:left">${item.source}</td>
                    <td style="text-align:right">${formatNumber(item.events)}</td>
                    <td style="text-align:right">${formatNumber(item.alerts)}</td>
                `;
                tbody.appendChild(row);
            });

            const total = document.createElement('tr');
            total.style.fontWeight = 'bold';
            total.innerHTML = `
                <td style="text-align:left">Итого</td>
                <td style="text-align:right">${formatNumber(events.reduce((sum, item) => sum + item.events, 0))}</td>
                <td style="text-align:right">${formatNumber(events.reduce((sum, item) => sum + item.alerts, 0))}</td>
            `;
            tbody.appendChild(total);
        }

        function fillAlertsTable() {
            const tbody = document.getElementById('alerts-table-body');
            tbody.innerHTML = '';

            alerts.forEach(item => {
                const row = document.createElement('tr');

                let priority = '';
                if (item.priority.includes('☢️')) priority = '<svg width="12" height="12" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" clip-rule="evenodd" d="M 2.5 0.5 c -0.8284 0 -1.5 0.6716 -1.5 1.5 c 0 0.8284 0.6716 1.5 1.5 1.5 h 11 c 0.8284 0 1.5 -0.6716 1.5 -1.5 c 0 -0.8284 -0.6716 -1.5 -1.5 -1.5 h -11 z" fill="#940000"/><path fill-rule="evenodd" clip-rule="evenodd" d="M 2.5 4.5 c -0.8284 0 -1.5 0.6716 -1.5 1.5 c 0 0.8284 0.6716 1.5 1.5 1.5 h 11 c 0.8284 0 1.5 -0.6716 1.5 -1.5 c 0 -0.8284 -0.6716 -1.5 -1.5 -1.5 h -11 z" fill="#940000"/><path fill-rule="evenodd" clip-rule="evenodd" d="M 2.5 8.5 c -0.8284 0 -1.5 0.6716 -1.5 1.5 c 0 0.8284 0.6716 1.5 1.5 1.5 h 11 c 0.8284 0 1.5 -0.6716 1.5 -1.5 c 0 -0.8284 -0.6716 -1.5 -1.5 -1.5 h -11 z" fill="#940000"/><path d="M 2.5 12.5 c -0.8284 0 -1.5 0.6716 -1.5 1.5 c 0 0.8284 0.6716 1.5 1.5 1.5 h 11 c 0.8284 0 1.5 -0.6716 1.5 -1.5 c 0 -0.8284 -0.6716 -1.5 -1.5 -1.5 h -11 z" fill="#940000"/></svg>';
                else if (item.priority.includes('🔴')) priority = '<svg width="12" height="12" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" clip-rule="evenodd" d="M 2.5 0.5 c -0.8284 0 -1.5 0.6716 -1.5 1.5 c 0 0.8284 0.6716 1.5 1.5 1.5 h 11 c 0.8284 0 1.5 -0.6716 1.5 -1.5 c 0 -0.8284 -0.6716 -1.5 -1.5 -1.5 h -11 z m 11 1 h -11 c -0.2761 0 -0.5 0.2239 -0.5 0.5 c 0 0.2761 0.2239 0.5 0.5 0.5 h 11 c 0.2761 0 0.5 -0.2239 0.5 -0.5 c 0 -0.2761 -0.2239 -0.5 -0.5 -0.5 z" fill="#B2B8BF"/><path fill-rule="evenodd" clip-rule="evenodd" d="M 2.5 4.5 c -0.8284 0 -1.5 0.6716 -1.5 1.5 c 0 0.8284 0.6716 1.5 1.5 1.5 h 11 c 0.8284 0 1.5 -0.6716 1.5 -1.5 c 0 -0.8284 -0.6716 -1.5 -1.5 -1.5 h -11 z" fill="#FF0000"/><path fill-rule="evenodd" clip-rule="evenodd" d="M 2.5 8.5 c -0.8284 0 -1.5 0.6716 -1.5 1.5 c 0 0.8284 0.6716 1.5 1.5 1.5 h 11 c 0.8284 0 1.5 -0.6716 1.5 -1.5 c 0 -0.8284 -0.6716 -1.5 -1.5 -1.5 h -11 z" fill="#FF0000"/><path d="M 2.5 12.5 c -0.8284 0 -1.5 0.6716 -1.5 1.5 c 0 0.8284 0.6716 1.5 1.5 1.5 h 11 c 0.8284 0 1.5 -0.6716 1.5 -1.5 c 0 -0.8284 -0.6716 -1.5 -1.5 -1.5 h -11 z" fill="#FF0000"/></svg>';
                else if (item.priority.includes('🟡')) priority = '<svg width="12" height="12" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" clip-rule="evenodd" d="M 2.5 0.5 c -0.8284 0 -1.5 0.6716 -1.5 1.5 c 0 0.8284 0.6716 1.5 1.5 1.5 h 11 c 0.8284 0 1.5 -0.6716 1.5 -1.5 c 0 -0.8284 -0.6716 -1.5 -1.5 -1.5 h -11 z m 11 1 h -11 c -0.2761 0 -0.5 0.2239 -0.5 0.5 c 0 0.2761 0.2239 0.5 0.5 0.5 h 11 c 0.2761 0 0.5 -0.2239 0.5 -0.5 c 0 -0.2761 -0.2239 -0.5 -0.5 -0.5 z" fill="#B2B8BF"/><path fill-rule="evenodd" clip-rule="evenodd" d="M 2.5 4.5 c -0.8284 0 -1.5 0.6716 -1.5 1.5 c 0 0.8284 0.6716 1.5 1.5 1.5 h 11 c 0.8284 0 1.5 -0.6716 1.5 -1.5 c 0 -0.8284 -0.6716 -1.5 -1.5 -1.5 h -11 z m 11 1 h -11 c -0.2761 0 -0.5 0.2239 -0.5 0.5 c 0 0.2761 0.2239 0.5 0.5 0.5 h 11 c 0.2761 0 0.5 -0.2239 0.5 -0.5 c 0 -0.2761 -0.2239 -0.5 -0.5 -0.5 z" fill="#B2B8BF"/><path fill-rule="evenodd" clip-rule="evenodd" d="M 2.5 8.5 c -0.8284 0 -1.5 0.6716 -1.5 1.5 c 0 0.8284 0.6716 1.5 1.5 1.5 h 11 c 0.8284 0 1.5 -0.6716 1.5 -1.5 c 0 -0.8284 -0.6716 -1.5 -1.5 -1.5 h -11 z" fill="#FFFF00"/><path d="M 2.5 12.5 c -0.8284 0 -1.5 0.6716 -1.5 1.5 c 0 0.8284 0.6716 1.5 1.5 1.5 h 11 c 0.8284 0 1.5 -0.6716 1.5 -1.5 c 0 -0.8284 -0.6716 -1.5 -1.5 -1.5 h -11 z" fill="#FFFF00"/></svg>';
                else if (item.priority.includes('🟢')) priority = '<svg width="12" height="12" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" clip-rule="evenodd" d="M 2.5 0.5 c -0.8284 0 -1.5 0.6716 -1.5 1.5 c 0 0.8284 0.6716 1.5 1.5 1.5 h 11 c 0.8284 0 1.5 -0.6716 1.5 -1.5 c 0 -0.8284 -0.6716 -1.5 -1.5 -1.5 h -11 z m 11 1 h -11 c -0.2761 0 -0.5 0.2239 -0.5 0.5 c 0 0.2761 0.2239 0.5 0.5 0.5 h 11 c 0.2761 0 0.5 -0.2239 0.5 -0.5 c 0 -0.2761 -0.2239 -0.5 -0.5 -0.5 z" fill="#B2B8BF"/><path fill-rule="evenodd" clip-rule="evenodd" d="M 2.5 4.5 c -0.8284 0 -1.5 0.6716 -1.5 1.5 c 0 0.8284 0.6716 1.5 1.5 1.5 h 11 c 0.8284 0 1.5 -0.6716 1.5 -1.5 c 0 -0.8284 -0.6716 -1.5 -1.5 -1.5 h -11 z m 11 1 h -11 c -0.2761 0 -0.5 0.2239 -0.5 0.5 c 0 0.2761 0.2239 0.5 0.5 0.5 h 11 c 0.2761 0 0.5 -0.2239 0.5 -0.5 c 0 -0.2761 -0.2239 -0.5 -0.5 -0.5 z" fill="#B2B8BF"/><path fill-rule="evenodd" clip-rule="evenodd" d="M 2.5 8.5 c -0.8284 0 -1.5 0.6716 -1.5 1.5 c 0 0.8284 0.6716 1.5 1.5 1.5 h 11 c 0.8284 0 1.5 -0.6716 1.5 -1.5 c 0 -0.8284 -0.6716 -1.5 -1.5 -1.5 h -11 z m 11 1 h -11 c -0.2761 0 -0.5 0.2239 -0.5 0.5 c 0 0.2761 0.2239 0.5 0.5 0.5 h 11 c 0.2761 0 0.5 -0.2239 0.5 -0.5 c 0 -0.2761 -0.2239 -0.5 -0.5 -0.5 z" fill="#B2B8BF"/><path d="M 2.5 12.5 c -0.8284 0 -1.5 0.6716 -1.5 1.5 c 0 0.8284 0.6716 1.5 1.5 1.5 h 11 c 0.8284 0 1.5 -0.6716 1.5 -1.5 c 0 -0.8284 -0.6716 -1.5 -1.5 -1.5 h -11 z" fill="#00FF00"/></svg>';

                row.innerHTML = `
                    <td style="text-align:left">${priority} ${item.rule}</td>
                    <td style="text-align:right">${formatNumber(item.count)}</td>
                `;
                tbody.appendChild(row);
            });

            const total = document.createElement('tr');
            total.style.fontWeight = 'bold';
            total.innerHTML = `
                <td style="text-align:left">Итого</td>
                <td style="text-align:right">${formatNumber(alerts.reduce((sum, item) => sum + item.count, 0))}</td>
            `;
            tbody.appendChild(total);
        }

        window.onload = initializeReport;
    </script>
</body>

</html>
